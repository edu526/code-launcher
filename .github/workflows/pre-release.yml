name: Pre-Release Build

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: read

jobs:
  build-deb:
    name: Build DEB Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-gi \
            python3-gi-cairo \
            gir1.2-gtk-3.0 \
            libgirepository1.0-dev \
            libcairo2-dev \
            pkg-config \
            dpkg

      - name: Build DEB package
        run: |
          bash packaging/build_deb.sh

      - name: Validate DEB package
        run: |
          # For pre-release, we use the version from build_deb.sh (1.0.0)
          DEB_FILE="dist/code-launcher_1.0.0_all.deb"

          if [ ! -f "$DEB_FILE" ]; then
            echo "❌ Error: DEB package not found at $DEB_FILE"
            ls -la dist/ || echo "dist/ directory not found"
            exit 1
          fi

          echo "✅ DEB package created successfully: $DEB_FILE"
          ls -lh "$DEB_FILE"

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: pre-release-deb-package
          path: dist/*.deb
          retention-days: 7

  build-appimage:
    name: Build AppImage Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-gi \
            python3-gi-cairo \
            gir1.2-gtk-3.0 \
            libgirepository1.0-dev \
            libcairo2-dev \
            pkg-config \
            wget \
            fuse \
            libfuse2

      - name: Download appimagetool
        run: |
          wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool-x86_64.AppImage

      - name: Build AppImage package
        run: |
          bash packaging/build_appimage.sh

      - name: Validate AppImage package
        run: |
          # For pre-release, we use the version from build_appimage.sh (1.0.0)
          APPIMAGE_FILE="dist/CodeLauncher-1.0.0-x86_64.AppImage"

          if [ ! -f "$APPIMAGE_FILE" ]; then
            echo "❌ Error: AppImage not found at $APPIMAGE_FILE"
            ls -la dist/ || echo "dist/ directory not found"
            exit 1
          fi

          echo "✅ AppImage created successfully: $APPIMAGE_FILE"
          ls -lh "$APPIMAGE_FILE"

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: pre-release-appimage-package
          path: dist/*.AppImage
          retention-days: 7

  report-status:
    name: Report Build Status
    runs-on: ubuntu-latest
    needs: [build-deb, build-appimage]
    if: always()

    steps:
      - name: Report build status
        run: |
          if [ "${{ needs.build-deb.result }}" == "success" ] && [ "${{ needs.build-appimage.result }}" == "success" ]; then
            echo "✅ Build successful - both packages are ready for testing"
          else
            echo "❌ Build failed - check logs for details"
            echo "DEB build: ${{ needs.build-deb.result }}"
            echo "AppImage build: ${{ needs.build-appimage.result }}"
            exit 1
          fi
